<?xml version="1.0" encoding="utf-8"?>
<!-- EN-Revision: 95fe2d7de6477ae5e28ae2e6f11eb4025f427b4f Maintainer: sergey Status: ready -->
<!-- Reviewed: no -->

<!-- Generated by xml_proto.php v2.3. Found in /scripts directory of phpdoc. -->
<refentry xml:id="function.win32-create-service" xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">
 <refnamediv>
  <refname>win32_create_service</refname>
  <refpurpose>Создаёт новую запись службы в базе данных SCM</refpurpose>
 </refnamediv>

 <refsect1 role="description">
  &reftitle.description;
  <methodsynopsis>
   <type>void</type><methodname>win32_create_service</methodname>
   <methodparam><type>array</type><parameter>details</parameter></methodparam>
   <methodparam choice="opt"><type>string</type><parameter>machine</parameter><initializer>&null;</initializer></methodparam>
  </methodsynopsis>
  <para>
   Функция пробует добавить службу в базу данных SCM. Для этого требуются права администратора.
  </para>
 </refsect1>

 <refsect1 role="parameters">
  &reftitle.parameters;
  <para>
   <variablelist>
    <varlistentry>
     <term><parameter>details</parameter></term>
     <listitem>
      <para>
       Массив деталей службы:
       <variablelist>
        <varlistentry>
         <term><parameter>service</parameter></term>
         <listitem>
          <para>
           Краткое название службы. Это имя для управления
           службой командой <literal>net</literal>.
           Служба должна быть уникальной (двум службам нельзя иметь одно и то же название)
           и, в идеале, не должна содержать пробелов в названии.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>display</parameter></term>
         <listitem>
          <para>
           Отображаемое имя службы. Это имя, которое показывает апплет служб.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>description</parameter></term>
         <listitem>
          <para>
           Подробное описание услуги. Это описание, которое показывает апплет служб.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>user</parameter></term>
         <listitem>
          <para>
           Имя учётной записи пользователя, под которой требуется
           запускать службу. Если этот параметр не указали, служба будет работать
           под учётной записью LocalSystem.
           При установке имени пользователя требуется указать и пароль.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>password</parameter></term>
         <listitem>
          <para>
           Пароль, который соответствуют пользователю <parameter>user</parameter>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>path</parameter></term>
         <listitem>
          <para>
           Полный путь к исполняемому модулю, который ОС запустит при запуске службы.
           Функция будет использовать путь к текущему процессу PHP, если параметр не указали.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>params</parameter></term>
         <listitem>
          <para>
           Параметры командной строки для передачи службе при её запуске.
           Если вы хотите запустить скрипт PHP как службу, то первым
           параметром должен быть полный путь к скрипту PHP, который вы собираетесь
           запустить. Полный путь к скрипту берут в кавычки <literal>"</literal>,
           если имя скрипта или путь содержат пробелы.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>load_order</parameter></term>
         <listitem>
          <para>
           Управляет load_order. Ещё не полностью поддерживается.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>svc_type</parameter></term>
         <listitem>
          <para>
           Устанавливает тип службы. Если опустили, функция будет использовать значение по умолчанию
           <constant>WIN32_SERVICE_WIN32_OWN_PROCESS</constant>.
           Это значение изменяют, когда точно знают, что делают.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>start_type</parameter></term>
         <listitem>
          <para>
           Устанавливает способ запуска службы. По умолчанию используется
           <constant>WIN32_SERVICE_AUTO_START</constant>, что означает,
           что служба будет запущена при запуске машины.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>error_control</parameter></term>
         <listitem>
          <para>
           Сообщает базе данных SCM, что она должна делать при обнаружении проблемы со службой.
           По умолчанию это <constant>WIN32_SERVER_ERROR_IGNORE</constant>.
           Изменение этого значения пока поддерживается не полностью.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>delayed_start</parameter></term>
         <listitem>
          <para>
           Если для параметра <parameter>delayed_start</parameter> установили значение &true;,
           это проинформирует БД SCM о том, что требуется запустить службу после
           запуска других служб автозапуска, плюс небольшая задержка.
          </para>
          <para>
           Любую службу можно пометить как службу с отложенным автозапуском; однако
           этот параметр не действует, если значением параметра <parameter>start_type</parameter>
           службы не равно <constant>WIN32_SERVICE_AUTO_START</constant>.
          </para>
          <para>
           Параметр применим только в Windows Vista и Windows Server 2008
           или более поздних версиях.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>base_priority</parameter></term>
         <listitem>
          <para>
           Чтобы уменьшить влияние на загрузку процессора, иногда требуется
           установка базового приоритета ниже обычного.
          </para>
          <para>
           Параметр <parameter>base_priority</parameter> принимает значение константы
           из списка <link linkend="win32service.constants.basepriorities">базовых классов приоритета Win32</link>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>dependencies</parameter></term>
         <listitem>
          <para>
           Чтобы определить зависимости для службы, иногда требуется установка
           для параметра списка имён служб в массиве.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_delay</parameter></term>
         <listitem>
          <para>
           Параметр определяет задержку между ошибкой и выполнением действия восстановления.
           Значение указывают в миллисекундах.
          </para>
          <para>
           Значение по умолчанию равно 60000.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_action_1</parameter></term>
         <listitem>
          <para>
           Действие, которое выполнится при первой ошибке. Значение по умолчанию —
           <constant>WIN32_SC_ACTION_NONE</constant>.
          </para>
          <para>
           Параметр <parameter>recovery_action_1</parameter> принимает значение константы
           из списка <link linkend="win32service.constants.recovery-action">действий восстановления Win32</link>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_action_2</parameter></term>
         <listitem>
          <para>
           Действие, которое выполнится при второй ошибке. Значение по умолчанию —
           <constant>WIN32_SC_ACTION_NONE</constant>.
          </para>
          <para>
           Параметр <parameter>recovery_action_2</parameter> принимает значение константы
           из списка <link linkend="win32service.constants.recovery-action">действий восстановления Win32</link>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_action_3</parameter></term>
         <listitem>
          <para>
           Действие, которое выполнится при очередных ошибках. Значение по умолчанию —
           <constant>WIN32_SC_ACTION_NONE</constant>.
          </para>
          <para>
           Параметр <parameter>recovery_action_3</parameter> принимает значение константы
           из списка <link linkend="win32service.constants.recovery-action">действий восстановления Win32</link>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_reset_period</parameter></term>
         <listitem>
          <para>
           Параметр определяет задержку, после которой сбрасывается счётчик отказов.
           Задержку указывают в секундах.
          </para>
          <para>
           Значение по умолчанию равно <literal>86400</literal>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_enabled</parameter></term>
         <listitem>
          <para>
           Со значением &true; параметр включает настройки восстановления,
           со значением &false; — отключает.
          </para>
          <para>
           Значение по умолчанию равно &false;
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_reboot_msg</parameter></term>
         <listitem>
          <para>
           Параметр определяет сообщение, которое сохраняется в журнале событий Windows
           перед перезагрузкой. Функция учитывает параметр, только если для какого-то действия
           установили значение <constant>WIN32_SC_ACTION_REBOOT</constant>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_command</parameter></term>
         <listitem>
          <para>
           Параметр определяет команду, которая выполняется, если какое-либо действие определили
           как <constant>WIN32_SC_ACTION_RUN_COMMAND</constant>.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><parameter>machine</parameter></term>
     <listitem>
      <para>
       Необязательное имя машины, на которой требуется создать службу.
       Функция будет работать с локальной машиной, если параметр не указали.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </para>
 </refsect1>

 <refsect1 role="returnvalues">
  &reftitle.returnvalues;
  <para>
   &return.void;
  </para>
  <para>
   До версии 1.0.0, &win32service.noerror.false.error;
  </para>
 </refsect1>

 <refsect1 role="errors">
  &reftitle.errors;
  <para>
   Функция выбрасывает исключение <classname>ValueError</classname>,
   если значение параметра <parameter>service</parameter> не задали.
  </para>
  <para>
   Функция выбрасывает исключение <classname>ValueError</classname>,
   если значение параметра <parameter>path</parameter> не задали.
  </para>
  <para>
   Функция выбрасывает исключение <classname>ValueError</classname>,
   если значение параметра <parameter>svc_type</parameter> указали неверно.
  </para>
  <para>
   Функция выбрасывает исключение <classname>ValueError</classname>,
   если значение параметра <parameter>start_type</parameter> указали неверно.
  </para>
  <para>
   Функция выбрасывает исключение <classname>ValueError</classname>,
   если значение параметра <parameter>error_control</parameter> указали неверно.
  </para>
  <para>
   Функция выбрасывает исключение <classname>ValueError</classname>,
   если значение параметра <parameter>base_priority</parameter> указали неверно.
  </para>
  <para>
   Функция выбрасывает исключение <classname>ValueError</classname>,
   если значение параметра <parameter>recovery_delay</parameter> выходит за пределы
   значений от 0 до PHP_INT_MAX.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>recovery_action_1</parameter> указано неверно.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>recovery_action_2</parameter> указано неверно.
  </para>
  <para>
   Функция выбрасывает исключение <classname>ValueError</classname>,
   если значение параметра <parameter>recovery_action_3</parameter> указали неверно.
  </para>
  <para>
   Функция выбрасывает исключение <classname>ValueError</classname>,
   значение параметра <parameter>recovery_reset_period</parameter> выходит за пределы
   значений от 0 и PHP_INT_MAX.
  </para>
  <para>
   Функция выбрасывает исключение <classname>Win32ServiceException</classname>,
   если возникла ошибка.
  </para>
 </refsect1>

 <refsect1 role="changelog">
  &reftitle.changelog;
  <para>
   <informaltable>
    <tgroup cols="2">
     <thead>
      <row>
       <entry>&Version;</entry>
       <entry>&Description;</entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>PECL-модуль win32service 1.0.0</entry>
       <entry>
        Функция выбрасывает исключение <classname>ValueError</classname>,
        если для параметров указали недопустимые данные,
        раньше возвращалось &false;.
       </entry>
      </row>
      <row>
       <entry>PECL-модуль win32service 1.0.0</entry>
       <entry>
        Функция выбрасывает исключение <classname>Win32ServiceException</classname>, если возникла ошибка,
        раньше возвращался
        <link xmlns="http://docbook.org/ns/docbook" linkend="win32service.constants.errors">Код ошибки Win32</link>.
       </entry>
      </row>
      <row>
       <entry>PECL-модуль win32service 1.0.0</entry>
       <entry>
        Тип возврата теперь <type>void</type>, раньше был <type>mixed</type>.
       </entry>
      </row>
      <row>
       <entry>PECL-модуль win32service 0.4.0</entry>
       <entry>
        Добавили параметры <parameter>dependencies</parameter>, <parameter>recovery_delay</parameter>,
        <parameter>recovery_action_1</parameter>, <parameter>recovery_action_2</parameter>,
        <parameter>recovery_action_3</parameter>, <parameter>recovery_reset_period</parameter>,
        <parameter>recovery_enabled</parameter>, <parameter>recovery_reboot_msg</parameter>
        и <parameter>recovery_command</parameter>.
       </entry>
      </row>
     </tbody>
    </tgroup>
   </informaltable>
  </para>
 </refsect1>

 <refsect1 role="examples">
  &reftitle.examples;
  <para>
   <example>
    <title>Пример использования функции <function>win32_create_service</function></title>
    <para>
     Пример создаёт сервис с кратким названием 'dummyphp'.
    </para>
    <programlisting role="php">
<![CDATA[
<?php

$x = win32_create_service(array(
    'service'     => 'dummyphp',                                           // Название сервиса
    'display'     => 'sample dummy PHP service',                           // Краткое описание
    'description' => 'This is a dummy Windows service created using PHP.', // Полное описание
    'params'      => '"' . __FILE__ . '"  run',                            // Путь до скрипта и параметров
));

debug_zval_dump($x);

?>
]]>
     </programlisting>
   </example>
  </para>
  <para>
   <example>
    <title>Пример работы функции <function>win32_create_service</function> с зависимостями</title>
    <para>
     Пример создаёт сервис с кратким названием 'dummyphp' и зависимостями.
    </para>
    <programlisting role="php">
<![CDATA[
<?php

$x = win32_create_service(array(
    'service'      => 'dummyphp',                                           // Название сервиса
    'display'      => 'sample dummy PHP service',                           // Краткое описание
    'description'  => 'This is a dummy Windows service created using PHP.', // Полное описание
    'params'       => '"' . __FILE__ . '"  run',                            // Путь до скрипта и параметров
    'dependencies' => array("Netman"),                                      // Список зависимостей
));

debug_zval_dump($x);

?>
]]>
     </programlisting>
   </example>
  </para>
  <para>
   <example>
    <title>Пример работы функции <function>win32_create_service</function> с восстановлением</title>
    <para>
     Пример создаёт сервис с кратким названием 'dummyphp' и настройками восстановления.
    </para>
    <programlisting role="php">
<![CDATA[
<?php

$x = win32_create_service(array(
    'service'               => 'dummyphp',                                           // Название сервиса
    'display'               => 'sample dummy PHP service',                           // Краткое описание
    'description'           => 'This is a dummy Windows service created using PHP.', // Полное описание
    'params'                => '"' . __FILE__ . '"  run',                            // Путь до скрипта и параметров
    'recovery_delay'        => 120000,                                               // Действие восстановления выполняется через 2 минуты.
    'recovery_action_1'     => WIN32_SC_ACTION_RESTART,                              // При первом сбое перезапускается служба.
    'recovery_action_2'     => WIN32_SC_ACTION_RUN_COMMAND,                          // При втором сбое выполняется команда
    'recovery_action_3'     => WIN32_SC_ACTION_NONE,                                 // При последующих сбоях ничего не делать
    'recovery_reset_period' => 86400,                                                // Сбросить счётчик ошибок через 1 день
    'recovery_enabled'      => true,                                                 // Включить параметр восстановления
    'recovery_reboot_msg'   => null,                                                 // Не определяйте сообщение о перезагрузке, здесь оно не требуется
    'recovery_command'      => "c:\clean-service.bat",                               // Когда действие — WIN32_SC_ACTION_RUN_COMMAND, выполняется эта команда
));

debug_zval_dump($x);

?>
]]>
     </programlisting>
   </example>
  </para>
 </refsect1>

 <refsect1 role="seealso">
  &reftitle.seealso;
  <para>
   <simplelist>
    <member><function>win32_delete_service</function></member>
    <member><link linkend="win32service.constants.basepriorities">Базовые классы приоритета Win32</link></member>
    <member><link linkend="win32service.constants.recovery-action">Действия восстановления Win32</link></member>
    <member><link linkend="win32service.constants.errors">Коды ошибок Win32</link></member>
   </simplelist>
  </para>
 </refsect1>

</refentry>
<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"~/.phpdoc/manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
